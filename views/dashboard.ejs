<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="main-header">
    <h1><%= sessionUser.user_name %> ã•ã‚“ã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
  </div>
  
  <div class="container">

    <!-- è¦è£œå……ãƒªã‚¹ãƒˆ -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-exclamation-triangle text-warning"></i>
          è¦è£œå……ãƒªã‚¹ãƒˆ
        </h2>
        <% if (lineConfigured) { %>
        <button id="sendReplenishToLine" class="line-btn btn-sm" data-user-id="<%= userId %>">
          <i class="fab fa-line"></i> LINEã§é€ä¿¡
        </button>
        <% } %>
      </div>
      <p class="text-secondary mb-4">åœ¨åº«ã‹ã‚‰ã™ãã«è£œå……ã—ãŸã»ã†ãŒã„ã„ã§ã™ã‚ˆ</p>
      <ul id="replenishList">
        <li>èª­ã¿è¾¼ã¿ä¸­...</li>
      </ul>
    </div>

    <!-- è²·ã„ç‰©ãƒªã‚¹ãƒˆ -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-shopping-cart text-danger"></i>
          è²·ã„ç‰©ãƒªã‚¹ãƒˆ
        </h2>
        <% if (lineConfigured) { %>
        <button id="sendShoppingToLine" class="line-btn btn-sm" data-user-id="<%= userId %>">
          <i class="fab fa-line"></i> LINEã§é€ä¿¡
        </button>
        <% } %>
      </div>
      <p class="text-secondary mb-4">é ¼ã¾ã‚Œã‚‹å‰ã«è²·ã£ã¦ãŠãã¨ãƒã‚¤ãƒ³ãƒˆé«˜ãã†</p>
      <ul id="shoppingList">
        <li>èª­ã¿è¾¼ã¿ä¸­...</li>
      </ul>
    </div>

    <!-- è‡¨æ™‚è³¼å…¥ä¾é ¼ -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-bolt text-warning"></i>
          è‡¨æ™‚è³¼å…¥ä¾é ¼
        </h2>
        <span class="section-subtitle">ä»Šæ—¥ã“ã‚Œè²·ã£ã¦ãã¦ï¼</span>
      </div>
      
      <div class="form-box">
        <div class="form-row">
          <div class="form-group" style="flex: 2;">
            <input type="text" id="tempItemName" placeholder="ã‚¢ã‚¤ãƒ†ãƒ åï¼ˆä¾‹: ç‰›ä¹³ã€ãƒ‘ãƒ³ï¼‰" required>
          </div>
          <div class="form-group" style="flex: 2;">
            <input type="text" id="tempDescription" placeholder="è©³ç´°ï¼ˆä»»æ„ï¼‰">
          </div>
          <div class="form-group" style="flex: 1;">
            <select id="tempPriority">
              <option value="1">é€šå¸¸</option>
              <option value="2">æ€¥ã</option>
              <option value="3">è¶…æ€¥ã</option>
            </select>
          </div>
          <button id="addTempPurchase" class="btn-success">
            <i class="fas fa-plus"></i> è¿½åŠ 
          </button>
        </div>
      </div>
      
      <div id="tempPurchaseList">
        <div class="text-muted">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>

    <!-- å ´æ‰€ä¸€è¦§ -->
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-map-marker-alt text-info"></i>
          ã‚ãªãŸã®å ´æ‰€ä¸€è¦§
        </h2>
      </div>
      
      <div class="tile-container">
        <% locations.forEach(loc => { %>
          <div class="tile">
            <h3><a href="/location/<%= loc.location_id %>"><%= loc.location_name %></a></h3>
            
            <!-- ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ -->
            <% if (loc.items && loc.items.length > 0) { %>
              <div class="mb-4">
                <% (loc.items || []).forEach(item => { %>
                  <div class="mb-2">
                    <%- include('item_partial', {item: item, locationId: loc.location_id }) %>
                  </div>
                <% }) %>
              </div>
            <% } else { %>
              <p class="text-muted text-sm mb-4">ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</p>
            <% } %>
            
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ -->
            <div class="flex items-center gap-2 text-sm text-secondary">
              <i class="fa-solid fa-users"></i> 
              <span><%= (loc.members || []).map(m => m.user_name).join(', ') %></span>
            </div>
          </div>
        <% }) %>
      </div>
      
      <!-- æ–°ã—ã„å ´æ‰€è¿½åŠ  -->
      <div class="form-box">
        <form action="/user/<%= sessionUser.user_id %>/add-location" method="POST" class="form-row">
          <div class="form-group" style="flex: 1;">
            <input type="text" name="location_name" placeholder="æ–°ã—ã„å ´æ‰€å" required>
          </div>
          <button type="submit" class="btn-success">
            <i class="fas fa-plus"></i> å ´æ‰€ã‚’è¿½åŠ 
          </button>
        </form>
      </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <div class="section">
      <div class="flex items-center justify-between">
        <a href="/user/<%= sessionUser.user_id %>/edit" class="btn btn-outline">
          <i class="fas fa-user-edit"></i> ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç·¨é›†
        </a>
        <a href="/logout" class="btn btn-secondary">
          <i class="fas fa-sign-out-alt"></i> ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
        </a>
      </div>
    </div>
    
  </div> <!-- /container -->
<script>
// location.ejsã¨åŒã˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function openAmountEdit(locationId, itemId, current) {
  const newVal = prompt('æ–°ã—ã„åœ¨åº«æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', current);
  if (newVal === null) return false;
  const val = parseInt(newVal, 10);
  if (isNaN(val) || val < 0) {
    alert('0ä»¥ä¸Šã®æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return false;
  }
  fetch(`/location/${locationId}/item/${itemId}/amount`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: `action=set&value=${encodeURIComponent(val)}`
  }).then(res => {
    if (res.ok) {
      location.reload();
    } else {
      alert('åœ¨åº«æ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });
  return false;
};
document.addEventListener('DOMContentLoaded', () => {
  document.body.addEventListener('click', e => {
    // Â±ãƒœã‚¿ãƒ³ç”¨
    if (e.target.matches('.decrement-btn') && !e.target.disabled) {
      const btn = e.target;
      const locationId = btn.getAttribute('data-location-id');
      const itemId = btn.getAttribute('data-item-id');
      fetch(`/location/${locationId}/item/${itemId}/amount`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'action=decrement'
      }).then(res => {
        if (res.ok) location.reload();
        else alert('åœ¨åº«æ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
      return;
    }

    if (e.target.matches('.increment-btn')) {
      const btn = e.target;
      const locationId = btn.getAttribute('data-location-id');
      const itemId = btn.getAttribute('data-item-id');
      fetch(`/location/${locationId}/item/${itemId}/amount`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'action=increment'
      }).then(res => {
        if (res.ok) location.reload();
        else alert('åœ¨åº«æ•°ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
      return;
    }

    // inuseãƒœã‚¿ãƒ³ç”¨ï¼ˆã“ã“ã§ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šï¼‰
    const inuseBtn = e.target.closest('.inuse-btn');
    if (inuseBtn && !inuseBtn.disabled) {
      e.preventDefault();

      const locationId = inuseBtn.getAttribute('data-location-id');
      const itemId = inuseBtn.getAttribute('data-item-id');
      const currentInuse = inuseBtn.getAttribute('data-current-inuse');
      const amount = inuseBtn.getAttribute('data-amount');

      fetch(`/location/${locationId}/item/${itemId}/inuse`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `current_inuse=${encodeURIComponent(currentInuse)}&amount=${encodeURIComponent(amount)}`
      }).then(res => {
        if (res.ok) {
          location.reload();
        } else {
          alert('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }).catch(() => {
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      });
      return;
    }
  });

  async function fetchAndRenderList(url, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '<li>èª­ã¿è¾¼ã¿ä¸­...</li>';
    try {
      const response = await fetch(url);
      if (!response.ok) throw new Error('é€šä¿¡å¤±æ•—');
      const items = await response.json();
      if (items.length === 0) {
        container.innerHTML = '<li>è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
        return;
      }
      container.innerHTML = '';
        items.forEach(item => {
          const li = document.createElement('li');
          li.textContent = `${item.item_name}@${item.location_name}ï¼ˆç¾åœ¨æ•°: ${item.amount}ï¼‰`;
          container.appendChild(li);
        });
    } catch (e) {
      container.innerHTML = '<li>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>';
    }
  }

  const userId = '<%= userId %>';
  fetchAndRenderList(`/api/dashboard/${userId}/replenish`, 'replenishList');
  fetchAndRenderList(`/api/dashboard/${userId}/shopping`, 'shoppingList');
  fetchAndRenderTempPurchases();

  // è‡¨æ™‚è³¼å…¥ä¾é ¼é–¢é€£ã®é–¢æ•°
  async function fetchAndRenderTempPurchases() {
    const container = document.getElementById('tempPurchaseList');
    container.innerHTML = '<li>èª­ã¿è¾¼ã¿ä¸­...</li>';
    try {
      const response = await fetch(`/api/temp-purchase/${userId}/active`);
      if (!response.ok) throw new Error('é€šä¿¡å¤±æ•—');
      const purchases = await response.json();
      
      if (purchases.length === 0) {
        container.innerHTML = '<div class="text-muted">ç¾åœ¨ã€è‡¨æ™‚è³¼å…¥ä¾é ¼ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      purchases.forEach(purchase => {
        const item = document.createElement('div');
        item.className = 'temp-purchase-item';
        if (purchase.priority === 3) item.className += ' priority-high';
        else if (purchase.priority === 2) item.className += ' priority-medium';
        
        const priorityEmoji = purchase.priority === 3 ? 'ğŸ”¥' : purchase.priority === 2 ? 'âš¡' : 'ğŸ“';
        const timeAgo = getTimeAgo(purchase.created_at);
        
        item.innerHTML = `
          <div class="temp-purchase-content">
            <div class="temp-purchase-title">${priorityEmoji} ${purchase.item_name}</div>
            ${purchase.description ? `<div class="text-sm text-secondary mb-1">${purchase.description}</div>` : ''}
            <div class="temp-purchase-meta">ä¾é ¼è€…: ${purchase.requested_by_name} | ${timeAgo}</div>
          </div>
          <div class="temp-purchase-actions">
            <button onclick="completeTempPurchase('${purchase.temp_id}')" class="btn btn-success btn-sm">
              <i class="fas fa-check"></i> å®Œäº†
            </button>
            <button onclick="deleteTempPurchase('${purchase.temp_id}')" class="btn btn-danger btn-sm">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        container.appendChild(item);
      });
    } catch (e) {
      container.innerHTML = '<li>ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</li>';
    }
  }

  function getTimeAgo(dateString) {
    const now = new Date();
    const date = new Date(dateString);
    const diffMs = now - date;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMins = Math.floor(diffMs / (1000 * 60));
    
    if (diffHours >= 24) {
      return `${Math.floor(diffHours / 24)}æ—¥å‰`;
    } else if (diffHours >= 1) {
      return `${diffHours}æ™‚é–“å‰`;
    } else if (diffMins >= 1) {
      return `${diffMins}åˆ†å‰`;
    } else {
      return 'æ•°ç§’å‰';
    }
  }

  // è‡¨æ™‚è³¼å…¥ä¾é ¼è¿½åŠ 
  document.getElementById('addTempPurchase').addEventListener('click', async function() {
    const itemName = document.getElementById('tempItemName').value.trim();
    const description = document.getElementById('tempDescription').value.trim();
    const priority = document.getElementById('tempPriority').value;
    
    if (!itemName) {
      alert('ã‚¢ã‚¤ãƒ†ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    
    const btn = this;
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'è¿½åŠ ä¸­...';
    
    try {
      const response = await fetch(`/api/temp-purchase/${userId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          item_name: itemName, 
          description: description || null, 
          priority: parseInt(priority) 
        })
      });
      
      const result = await response.json();
      
      if (response.ok) {
        // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
        document.getElementById('tempItemName').value = '';
        document.getElementById('tempDescription').value = '';
        document.getElementById('tempPriority').value = '1';
        
        // ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
        fetchAndRenderTempPurchases();
        alert('âœ… ' + result.message);
      } else {
        alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
      }
    } catch (error) {
      alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  });

  // è‡¨æ™‚è³¼å…¥ä¾é ¼å®Œäº†
  window.completeTempPurchase = async function(tempId) {
    if (!confirm('ã“ã®è‡¨æ™‚è³¼å…¥ä¾é ¼ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      const response = await fetch(`/api/temp-purchase/${tempId}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (response.ok) {
        fetchAndRenderTempPurchases();
        alert('âœ… ' + result.message);
      } else {
        alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
      }
    } catch (error) {
      alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  };

  // è‡¨æ™‚è³¼å…¥ä¾é ¼å‰Šé™¤
  window.deleteTempPurchase = async function(tempId) {
    if (!confirm('ã“ã®è‡¨æ™‚è³¼å…¥ä¾é ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      const response = await fetch(`/api/temp-purchase/${tempId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (response.ok) {
        fetchAndRenderTempPurchases();
        alert('âœ… ' + result.message);
      } else {
        alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
      }
    } catch (error) {
      alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    }
  };

  // LINEé€ä¿¡ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆLINEè¨­å®šæ™‚ã®ã¿ï¼‰
  <% if (lineConfigured) { %>
  const sendReplenishBtn = document.getElementById('sendReplenishToLine');
  if (sendReplenishBtn) {
    sendReplenishBtn.addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€ä¿¡ä¸­...';
    
    try {
      const response = await fetch(`/api/dashboard/${userId}/line/replenish`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('âœ… ' + result.message);
      } else {
        alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
      }
    } catch (error) {
      alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
    });
  }

  const sendShoppingBtn = document.getElementById('sendShoppingToLine');
  if (sendShoppingBtn) {
    sendShoppingBtn.addEventListener('click', async function() {
    const btn = this;
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> é€ä¿¡ä¸­...';
    
    try {
      const response = await fetch(`/api/dashboard/${userId}/line/shopping`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      const result = await response.json();
      
      if (response.ok) {
        alert('âœ… ' + result.message);
      } else {
        alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
      }
    } catch (error) {
      alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
    });
  }
  <% } %>
});
</script>
</body>
</html>
