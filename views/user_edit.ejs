<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ユーザー情報編集</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="main-header">
    <h1>
      <i class="fas fa-user-edit text-primary"></i>
      ユーザー情報の編集
    </h1>
  </div>
  
  <div class="container">
    <!-- ユーザー情報編集フォーム -->
    <div class="section">
      <form method="POST" action="/user/<%= user.user_id %>/edit">
        <div class="form-group">
          <label for="user_name">
            <i class="fas fa-user text-primary"></i>
            ユーザー名
          </label>
          <input type="text" id="user_name" name="user_name" value="<%= user.user_name %>" required>
        </div>
        
        <div class="form-group">
          <label for="email">
            <i class="fas fa-envelope text-info"></i>
            メールアドレス
          </label>
          <input type="email" id="email" name="email" value="<%= user.email %>" disabled>
          <p class="text-muted text-sm">メールアドレスを変更する場合は、下のボタンから変更手続きを行ってください</p>
          <button type="button" id="changeEmailBtn" class="btn btn-info btn-sm">
            <i class="fas fa-envelope-open"></i> メールアドレス変更
          </button>
        </div>
        
        <div class="form-group">
          <label for="user_description">
            <i class="fas fa-info-circle text-secondary"></i>
            説明・プロフィール
          </label>
          <textarea id="user_description" name="user_description" rows="4" required><%= user.user_description %></textarea>
        </div>
        
        <div class="form-group">
          <label for="line_user_id">
            <i class="fab fa-line text-success"></i>
            LINE通知設定
          </label>
          <input type="text" id="line_user_id" name="line_user_id" value="<%= user.line_user_id || '' %>" placeholder="LINEユーザーID（例: U1234567890abcdef1234567890abcdef）" readonly>
          <div class="text-sm" style="margin-top: 0.5rem;">
            <% if (user.line_user_id) { %>
              <span class="status-label Green">
                <i class="fas fa-check"></i>
                LINE連携済み
              </span>
            <% } else { %>
              <span class="status-label Yellow">
                <i class="fas fa-exclamation-triangle"></i>
                LINE連携が必要です
              </span>
            <% } %>
          </div>
          <div style="margin-top: 0.75rem;">
            <% if (user.line_user_id) { %>
              <button type="button" id="removeLineBtn" class="btn btn-danger btn-sm">
                <i class="fas fa-unlink"></i> LINE連携を解除
              </button>
            <% } else { %>
              <button type="button" id="setupLineBtn" class="line-btn btn-sm">
                <i class="fab fa-line"></i> LINE連携を設定
              </button>
            <% } %>
          </div>
        </div>
        
        <div class="flex gap-4">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> 保存
          </button>
          <a href="/user/<%= user.user_id %>" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> ダッシュボードに戻る
          </a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // LINE連携設定ボタン
    const setupBtn = document.getElementById('setupLineBtn');
    if (setupBtn) {
      setupBtn.addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '🔄 リンク生成中...';
        
        try {
          const response = await fetch(`/api/line/generate-link/<%= user.user_id %>`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // 新しいウィンドウでLINE連携ページを開く
            window.open(result.linkUrl, '_blank', 'width=600,height=700');
            
            alert(`📱 LINE連携用のページを開きました。\n\n手順:\n1. Zaikon Botを友だち追加\n2. リンクコード「${result.linkCode}」を送信\n3. このページを再読み込み`);
          } else {
            alert('❌ ' + (result.error || 'エラーが発生しました'));
          }
        } catch (error) {
          alert('❌ 通信エラーが発生しました');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });
    }

    // LINE連携解除ボタン
    const removeBtn = document.getElementById('removeLineBtn');
    if (removeBtn) {
      removeBtn.addEventListener('click', async function() {
        if (!confirm('LINE連携を解除しますか？\n\n解除すると、LINE通知を受け取れなくなります。')) {
          return;
        }

        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '🔄 解除中...';
        
        try {
          const response = await fetch(`/api/line/remove-link/<%= user.user_id %>`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('✅ LINE連携を解除しました。\n\nページを再読み込みします。');
            location.reload();
          } else {
            alert('❌ ' + (result.error || 'エラーが発生しました'));
          }
        } catch (error) {
          alert('❌ 通信エラーが発生しました');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });
    }

    // メールアドレス変更ボタン
    const changeEmailBtn = document.getElementById('changeEmailBtn');
    if (changeEmailBtn) {
      changeEmailBtn.addEventListener('click', async function() {
        const newEmail = prompt('新しいメールアドレスを入力してください:');
        if (!newEmail) return;

        if (!newEmail.includes('@') || newEmail.length < 5) {
          alert('有効なメールアドレスを入力してください。');
          return;
        }

        if (!confirm(`メールアドレスを ${newEmail} に変更しますか？\n\n現在のメールアドレス（<%= user.email %>）に確認メールが送信されます。`)) {
          return;
        }

        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '📧 送信中...';
        
        try {
          const response = await fetch(`/send-email-change-link/<%= user.user_id %>`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ newEmail: newEmail })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('✅ ' + result.message + '\n\nメール内のリンクから変更手続きを完了してください。');
          } else {
            alert('❌ ' + (result.error || 'エラーが発生しました'));
          }
        } catch (error) {
          alert('❌ 通信エラーが発生しました');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });
    }
  </script>
</body>
</html>