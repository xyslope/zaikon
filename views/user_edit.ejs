<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <div class="main-header">
    <h1>
      <i class="fas fa-user-edit text-primary"></i>
      ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç·¨é›†
    </h1>
  </div>
  
  <div class="container">
    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="section">
      <form method="POST" action="/user/<%= user.user_id %>/edit">
        <div class="form-group">
          <label for="user_name">
            <i class="fas fa-user text-primary"></i>
            ãƒ¦ãƒ¼ã‚¶ãƒ¼å
          </label>
          <input type="text" id="user_name" name="user_name" value="<%= user.user_name %>" required>
        </div>
        
        <div class="form-group">
          <label for="email">
            <i class="fas fa-envelope text-info"></i>
            ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
          </label>
          <input type="email" id="email" name="email" value="<%= user.email %>" disabled>
          <p class="text-muted text-sm">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰å¤‰æ›´æ‰‹ç¶šãã‚’è¡Œã£ã¦ãã ã•ã„</p>
          <button type="button" id="changeEmailBtn" class="btn btn-info btn-sm">
            <i class="fas fa-envelope-open"></i> ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´
          </button>
        </div>
        
        <div class="form-group">
          <label for="user_description">
            <i class="fas fa-info-circle text-secondary"></i>
            èª¬æ˜ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
          </label>
          <textarea id="user_description" name="user_description" rows="4" required><%= user.user_description %></textarea>
        </div>
        
        <div class="form-group">
          <label for="line_user_id">
            <i class="fab fa-line text-success"></i>
            LINEé€šçŸ¥è¨­å®š
          </label>
          <input type="text" id="line_user_id" name="line_user_id" value="<%= user.line_user_id || '' %>" placeholder="LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¾‹: U1234567890abcdef1234567890abcdefï¼‰" readonly>
          <div class="text-sm" style="margin-top: 0.5rem;">
            <% if (user.line_user_id) { %>
              <span class="status-label Green">
                <i class="fas fa-check"></i>
                LINEé€£æºæ¸ˆã¿
              </span>
            <% } else { %>
              <span class="status-label Yellow">
                <i class="fas fa-exclamation-triangle"></i>
                LINEé€£æºãŒå¿…è¦ã§ã™
              </span>
            <% } %>
          </div>
          <div style="margin-top: 0.75rem;">
            <% if (user.line_user_id) { %>
              <button type="button" id="removeLineBtn" class="btn btn-danger btn-sm">
                <i class="fas fa-unlink"></i> LINEé€£æºã‚’è§£é™¤
              </button>
            <% } else { %>
              <button type="button" id="setupLineBtn" class="line-btn btn-sm">
                <i class="fab fa-line"></i> LINEé€£æºã‚’è¨­å®š
              </button>
            <% } %>
          </div>
        </div>
        
        <div class="flex gap-4">
          <button type="submit" class="btn btn-success">
            <i class="fas fa-save"></i> ä¿å­˜
          </button>
          <a href="/user/<%= user.user_id %>" class="btn btn-outline">
            <i class="fas fa-arrow-left"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
          </a>
        </div>
      </form>
    </div>
  </div>

  <script>
    // LINEé€£æºè¨­å®šãƒœã‚¿ãƒ³
    const setupBtn = document.getElementById('setupLineBtn');
    if (setupBtn) {
      setupBtn.addEventListener('click', async function() {
        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = 'ğŸ”„ ãƒªãƒ³ã‚¯ç”Ÿæˆä¸­...';
        
        try {
          const response = await fetch(`/api/line/generate-link/<%= user.user_id %>`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§LINEé€£æºãƒšãƒ¼ã‚¸ã‚’é–‹ã
            window.open(result.linkUrl, '_blank', 'width=600,height=700');
            
            alert(`ğŸ“± LINEé€£æºç”¨ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸã€‚\n\næ‰‹é †:\n1. Zaikon Botã‚’å‹ã ã¡è¿½åŠ \n2. ãƒªãƒ³ã‚¯ã‚³ãƒ¼ãƒ‰ã€Œ${result.linkCode}ã€ã‚’é€ä¿¡\n3. ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿`);
          } else {
            alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
          }
        } catch (error) {
          alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });
    }

    // LINEé€£æºè§£é™¤ãƒœã‚¿ãƒ³
    const removeBtn = document.getElementById('removeLineBtn');
    if (removeBtn) {
      removeBtn.addEventListener('click', async function() {
        if (!confirm('LINEé€£æºã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nè§£é™¤ã™ã‚‹ã¨ã€LINEé€šçŸ¥ã‚’å—ã‘å–ã‚Œãªããªã‚Šã¾ã™ã€‚')) {
          return;
        }

        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = 'ğŸ”„ è§£é™¤ä¸­...';
        
        try {
          const response = await fetch(`/api/line/remove-link/<%= user.user_id %>`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('âœ… LINEé€£æºã‚’è§£é™¤ã—ã¾ã—ãŸã€‚\n\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã™ã€‚');
            location.reload();
          } else {
            alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
          }
        } catch (error) {
          alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });
    }

    // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å¤‰æ›´ãƒœã‚¿ãƒ³
    const changeEmailBtn = document.getElementById('changeEmailBtn');
    if (changeEmailBtn) {
      changeEmailBtn.addEventListener('click', async function() {
        const newEmail = prompt('æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (!newEmail) return;

        if (!newEmail.includes('@') || newEmail.length < 5) {
          alert('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (!confirm(`ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ ${newEmail} ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\n\nç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆ<%= user.email %>ï¼‰ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚`)) {
          return;
        }

        const btn = this;
        const originalText = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = 'ğŸ“§ é€ä¿¡ä¸­...';
        
        try {
          const response = await fetch(`/send-email-change-link/<%= user.user_id %>`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ newEmail: newEmail })
          });
          
          const result = await response.json();
          
          if (response.ok) {
            alert('âœ… ' + result.message + '\n\nãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å¤‰æ›´æ‰‹ç¶šãã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
          } else {
            alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
          }
        } catch (error) {
          alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        } finally {
          btn.disabled = false;
          btn.innerHTML = originalText;
        }
      });
    }
  </script>
</body>
</html>