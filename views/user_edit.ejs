<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ç·¨é›†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
  <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ç·¨é›†</h1>
  <form method="POST" action="/user/<%= user.user_id %>/edit">
    <label>ãƒ¦ãƒ¼ã‚¶ãƒ¼å: <input type="text" name="user_name" value="<%= user.user_name %>" required></label><br>
    <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: <input type="email" name="email" value="<%= user.email %>" disabled></label><br>
    <label>èª¬æ˜ãƒ»ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«:<br>
      <textarea name="user_description" rows="4" cols="40" required><%= user.user_description %></textarea>
    </label><br>
    <label>LINEé€šçŸ¥è¨­å®š:<br>
      <input type="text" name="line_user_id" value="<%= user.line_user_id || '' %>" placeholder="LINEãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆä¾‹: U1234567890abcdef1234567890abcdefï¼‰" readonly>
      <br><small style="color: #666;">
        <% if (user.line_user_id) { %>
          âœ… LINEé€£æºæ¸ˆã¿
        <% } else { %>
          âš ï¸ LINEé€£æºãŒå¿…è¦ã§ã™
        <% } %>
      </small>
      <br>
      <button type="button" id="setupLineBtn" style="background: #00C300; color: white; padding: 8px 16px; border: none; border-radius: 20px; margin-top: 5px;">
        ğŸ”— LINEé€£æºã‚’è¨­å®š
      </button>
    </label><br>
    <button type="submit">ä¿å­˜</button>
  </form>
  <p><a href="/user/<%= user.user_id %>">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a></p>

  <script>
    document.getElementById('setupLineBtn').addEventListener('click', async function() {
      const btn = this;
      const originalText = btn.innerHTML;
      
      btn.disabled = true;
      btn.innerHTML = 'ğŸ”„ ãƒªãƒ³ã‚¯ç”Ÿæˆä¸­...';
      
      try {
        const response = await fetch(`/api/line/generate-link/<%= user.user_id %>`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok) {
          // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§LINEé€£æºãƒšãƒ¼ã‚¸ã‚’é–‹ã
          window.open(result.linkUrl, '_blank', 'width=600,height=700');
          
          alert(`ğŸ“± LINEé€£æºç”¨ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ãã¾ã—ãŸã€‚\n\næ‰‹é †:\n1. Zaikon Botã‚’å‹ã ã¡è¿½åŠ \n2. ãƒªãƒ³ã‚¯ã‚³ãƒ¼ãƒ‰ã€Œ${result.linkCode}ã€ã‚’é€ä¿¡\n3. ã“ã®ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿`);
        } else {
          alert('âŒ ' + (result.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'));
        }
      } catch (error) {
        alert('âŒ é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    });
  </script>
</body>
</html>